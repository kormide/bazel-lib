# Create a pull request to update the bazel central registry
# when a new release has been cut.
name: BCR

on:
  release:
    types: [published]

jobs:
  pull-request:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v2
        with:
          node-version: "14"
      - name: Get the version
        id: get_version
        run: echo ::set-output name=VERSION::${GITHUB_REF#refs/tags/}
      - name: Checkout the released version of this repo
        uses: actions/checkout@v2
        with:
          ref: ${{ env.GITHUB_REF }}
          path: ${{ env.GITHUB_REPOSITORY }}
      - name: Checkout bcr
        uses: actions/checkout@v3
        with:
          #TODO: change to bazelbuild
          repository: kormide/bazel-central-registry
          path: bcr
      - name: Create a new bcr branch
        working-directory: bcr
        run: git checkout -b "$GITHUB_REPOSITORY@${{ steps.get_version.outputs.VERSION }}"
      - name: Create the bcr entry
        run: node .github/workflows/create-bcr-entry.js $GITHUB_REPOSITORY bcr ${{ steps.get_version.outputs.VERSION }}
